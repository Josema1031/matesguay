<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Panel de Administraci√≥n</title>
  <link rel="shortcut icon" href="imag/LOGO-ADMINISTRADOR.png" type="image/x-icon">

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background-color: #f0f0f0;
    }

    h1 {
      text-align: center;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
    }

    th,
    td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center;
    }


    #password {
      width: 100%;
      padding: 5px;

    }

    #email {
      width: 100%;
      padding: 5px;

    }

    button {
      padding: 8px 12px;
      margin: 5px;
      cursor: pointer;
    }

    #acciones {
      text-align: center;
      margin-top: 20px;
    }

    #login-container {
      max-width: 400px;
      height: 400px;
      margin: 100px auto;
      padding: 20px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    #admin-panel {
      display: none;
    }

    .toggle-password {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
    }

    .precio-anterior {
      text-decoration: line-through;
      color: gray;
    }

    .precio-actual {
      font-weight: bold;
      color: green;
      font-size: 18px;
    }

    .etiqueta-descuento {
      background-color: red;
      color: white;
      padding: 5px 8px;
      border-radius: 4px;
      font-size: 14px;
      position: absolute;
      top: 10px;
      right: 10px;
    }

    /* Mantener ancho fijo y columnas equilibradas */
    #tabla-productos {
      table-layout: fixed;
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    /* Ajuste de anchos por columna */
    #tabla-productos th:nth-child(1),
    #tabla-productos td:nth-child(1) {
      width: 170px;
    }

    /* Nombre */

    #tabla-productos th:nth-child(2),
    #tabla-productos td:nth-child(2) {
      width: 80px;
    }

    /* Precio */

    #tabla-productos th:nth-child(3),
    #tabla-productos td:nth-child(3) {
      width: 90px;
    }

    /* Precio anterior */

    #tabla-productos th:nth-child(4),
    #tabla-productos td:nth-child(4) {
      width: 100px;
    }

    /* % Desc. */

    #tabla-productos th:nth-child(6),
    #tabla-productos td:nth-child(6) {
      width: 100px;
    }

    /* Precio Mayorista */

    #tabla-productos th:nth-child(7),
    #tabla-productos td:nth-child(7) {
      width: 80px;
    }

    /* Unidades x Pack */

    #tabla-productos th:nth-child(8),
    #tabla-productos td:nth-child(8) {
      width: 100px;
    }

    /* Categor√≠a */

    #tabla-productos th:nth-child(9),
    #tabla-productos td:nth-child(9) {
      width: 150px;
    }

    /* Tipo de venta */

    #tabla-productos th:nth-child(10),
    #tabla-productos td:nth-child(10) {
      width: 200px;
    }

    /* Imagen */

    #tabla-productos th:nth-child(11),
    #tabla-productos td:nth-child(11) {
      width: 80px;
    }

    /* Acciones */

    /* Compactar inputs y selects */
    #tabla-productos input,
    #tabla-productos select {
      width: 100%;
      padding: 4px;
      font-size: 13px;
      box-sizing: border-box;
    }

    /* Imagen m√°s peque√±a */
    #tabla-productos img {
      max-width: 50px;
      height: auto;
    }

    /* Bordes y estilo */
    #tabla-productos th,
    #tabla-productos td {
      border: 1px solid #ddd;
      padding: 6px;
      text-align: center;
    }

    /* Encabezado con fondo */
    #tabla-productos th {
      background-color: #f5f5f5;
      font-weight: bold;
    }

    /* Contenedor con scroll horizontal si es necesario */
    .tabla-contenedor {
      overflow-x: auto;
    }
  </style>
</head>

<body>

  <!-- Login -->
  <div id="login-container">
    <div id="loader" style="display:none; text-align:center; margin-top: 20px;">
      <p>Cargando autenticaci√≥n...</p>
    </div>

    <h1>Panel de Administraci√≥n de Productos - <span id="MATES-GUAY"></span></h1>
    <!--cambiar para nuevas tiendas -->
    <input type="email" id="email" placeholder="Correo electr√≥nico"><br><br>
    <div style="position: relative; display: inline-block; width: 100%;">
      <input type="password" id="password" placeholder="Contrase√±a">
      <span onclick="togglePassword()" class="toggle-password">üëÅÔ∏è</span>
    </div>
    <button onclick="login()">Ingresar</button>
    <p id="mensaje-error" style="color:red;"></p>
  </div>

  <!-- Panel oculto hasta que se loguee -->
  <div id="admin-panel">
    <div style="text-align: center; margin-top: 20px;">
      <input type="text" id="buscador-admin" placeholder="Buscar productos..."
        style="width: 50%; padding: 10px; font-size: 16px;">
    </div>

    <h1>Panel de Administraci√≥n de Productos</h1>

    <div id="acciones">
      <button onclick="agregarProducto()">‚ûï Agregar Producto</button>
      <button onclick="guardarProductos()">üíæ Guardar Cambios</button>
      <button onclick="cerrarSesion()" style="background-color: darkred; color: white;">üîí Cerrar sesi√≥n</button>
    </div>

    <table id="tabla-productos">
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Precio</th>
          <th>Precio Anterior</th>
          <th>% Descuento</th>
          <th>Precio Mayorista</th>
          <th>Unidades por Pack</th>
          <th>Categoria</th>
          <th>tipo de venta</th>
          <th>Imagen (URL)</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <div id="paginacion" style="text-align:center; margin-top:20px;"></div>


  <!-- Firebase SDKs -->
  <script type="module">

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";

    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    // Tu configuraci√≥n de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyA36uwBk0FBDc6rI16BAsqUNe_AXLpv62Q",
      authDomain: "carniceriadonjose-48638.firebaseapp.com",
      projectId: "carniceriadonjose-48638",
      storageBucket: "carniceriadonjose-48638.appspot.com",
      messagingSenderId: "322531750471",
      appId: "1:322531750471:web:78e290c9c81eecc7be3762"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const tiendaId = "MATES-GUAY"; // cambiar para nuevas tiendas
    const productosRef = collection(db, "tiendas", tiendaId, "productos");

    // üîë FUNCI√ìN LOGIN MANUAL

    window.login = async function () {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      const error = document.getElementById("mensaje-error");

      try {
        const credencial = await signInWithEmailAndPassword(auth, email, password);
        sessionStorage.setItem("loginManual", "true");

        // Ahora que el login fue exitoso, forzamos el cambio visual
        document.getElementById("login-container").style.display = "none";
        document.getElementById("admin-panel").style.display = "block";
        mostrarProductos();

        error.textContent = "";
      } catch (e) {
        console.error(e);
        error.textContent = "‚ùå Correo o contrase√±a incorrectos.";
      }
    };

    // üîç DETECCI√ìN DE USUARIO LOGUEADO AL CARGAR

    onAuthStateChanged(auth, user => {
      const login = document.getElementById("login-container");
      const panel = document.getElementById("admin-panel");

      const loginManual = sessionStorage.getItem("loginManual");

      if (user && loginManual === "true") {
        login.style.display = "none";
        panel.style.display = "block";
        mostrarProductos();
      } else {
        login.style.display = "block";
        panel.style.display = "none";
      }
    });

    //  üö™ FUNCI√ìN CERRAR SESI√ìN

    window.cerrarSesion = function () {
      sessionStorage.removeItem("loginManual");
      signOut(auth);
    };

    let productos = [];
    let productosOriginales = [];
    let paginaActual = 1;
    const productosPorPagina = 10;
    window.productos = productos;

    //üì¶ MOSTRAR PRODUCTOS (CON CACH√â)

    async function mostrarProductos() {
      document.getElementById("loader") // mostrar loader

      // Si hay productos cacheados en sessionStorage, mostralos primero
      const cache = sessionStorage.getItem("productosAdmin");
      if (cache) {
        productos = JSON.parse(cache);
        renderTabla();
      }

      try {
        const snapshot = await getDocs(productosRef);
        productos = snapshot.docs.map(docSnap => ({
          id: docSnap.id,
          ...docSnap.data()
        }));
        productosOriginales = JSON.parse(JSON.stringify(productos)); // Copia profunda


        sessionStorage.setItem("productosAdmin", JSON.stringify(productos));
        renderTabla();
      } catch (error) {
        alert("‚ùå Error al cargar los productos desde Firebase");
        console.error(error);
      } finally {
        document.getElementById("loader").style.display = "none"; // ocultar loader
      }
    }
    //  üîé B√öSQUEDA EN TIEMPO REAL

    document.getElementById("buscador-admin").addEventListener("input", function () {
      const texto = this.value.toLowerCase().trim();

      const filtrados = productos.filter(prod =>
        prod.nombre.toLowerCase().includes(texto) ||
        prod.categoria.toLowerCase().includes(texto) ||
        prod.tipoVenta.toLowerCase().includes(texto)
      );

      paginaActual = 1; // Reinicia a la primera p√°gina cuando buscas
      renderTabla(filtrados);
    });

    // ‚úèÔ∏è EDITAR PRODUCTO

    window.editar = function (index, campo, valor) {
      if (campo === 'precio' || campo === 'precioAnterior' || campo === 'descuento') {
        productos[index][campo] = valor === "" ? null : parseFloat(valor);

        const precio = parseFloat(productos[index].precio);
        const precioAnterior = parseFloat(productos[index].precioAnterior);
        const descuento = parseFloat(productos[index].descuento);

        const filas = document.querySelectorAll("#tabla-productos tbody tr");
        const fila = filas[index % 10]; // Solo para la p√°gina actual

        // Si escrib√≠s el descuento, calcular precioAnterior
        if (campo === 'descuento' && !isNaN(descuento) && !isNaN(precio) && descuento > 0 && descuento < 100) {
          const nuevoPrecioAnterior = Math.round(precio / (1 - descuento / 100));
          productos[index].precioAnterior = nuevoPrecioAnterior;

          // Actualizar visualmente el input de precioAnterior
          if (fila) {
            const inputPrecioAnterior = fila.querySelectorAll("td input")[2]; // √≠ndice 2 = precioAnterior
            if (inputPrecioAnterior) inputPrecioAnterior.value = nuevoPrecioAnterior;
          }
        }

        // Si escrib√≠s el precioAnterior, calcular descuento
        if (campo === 'precioAnterior' && !isNaN(precio) && !isNaN(precioAnterior) && precioAnterior > precio) {
          const nuevoDescuento = Math.round((1 - precio / precioAnterior) * 100);
          productos[index].descuento = nuevoDescuento;

          // Actualizar visualmente el input de descuento
          if (fila) {
            const inputDescuento = fila.querySelectorAll("td input")[3]; // √≠ndice 3 = descuento
            if (inputDescuento) inputDescuento.value = nuevoDescuento;
          }
        }

      } else {
        productos[index][campo] = valor;
      }
    };

    //    ‚ûï AGREGAR / GUARDAR PRODUCTO

    window.agregarProducto = function () {
      productos.unshift({
        nombre: "",
        precio: 0,
        imagen: "",
        categoria: "Arroz",
        tipoVenta: "kg",
        id: null
      });
      renderTabla();
    };

    // üìã RENDERIZAR TABLA DE PRODUCTOS

    function renderTabla(lista = productos) {
      const tbody = document.querySelector("#tabla-productos tbody");
      tbody.innerHTML = "";

      const inicio = (paginaActual - 1) * productosPorPagina;
      const fin = inicio + productosPorPagina;
      const productosPagina = lista.slice(inicio, fin);

      productosPagina.forEach((prod, index) => {
        const fila = document.createElement("tr");
        fila.setAttribute("draggable", "true");
        fila.setAttribute("data-id", prod.id);
        fila.addEventListener("dragstart", dragStart);
        fila.addEventListener("dragover", dragOver);
        fila.addEventListener("drop", drop);

        fila.innerHTML = `
      <td><input type="text" value="${prod.nombre}" onchange="editar(${inicio + index}, 'nombre', this.value)"></td>

      <td><input type="number" value="${prod.precio}" onchange="editar(${inicio + index}, 'precio', this.value)"></td>
      <td><input type="number" value="${prod.precioAnterior ?? ''}" onchange="editar(${inicio + index}, 'precioAnterior', this.value)"></td>
      <td><input type="number" value="${prod.descuento ?? ''}" onchange="editar(${inicio + index}, 'descuento', this.value)"></td>
      <td><input type="number" value="${prod.precioMayorista ?? ''}" onchange="editar(${inicio + index}, 'precioMayorista', this.value)"></td>
      <td><input type="number" value="${prod.unidadesPack ?? ''}" onchange="editar(${inicio + index}, 'unidadesPack', this.value)"></td>
     
      <td>
        <select onchange="editar(${inicio + index}, 'categoria', this.value)">
          <option value="Imperial" ${prod.categoria === "Imperial" ? "selected" : ""}>Imperial</option>
          <option value="Torpedo" ${prod.categoria === "Torpedo" ? "selected" : ""}>Torpedo</option>
          <option value="Camionero" ${prod.categoria === "Camionero" ? "selected" : ""}>Camionero</option>
          <option value="Combo" ${prod.categoria === "Combo" ? "selected" : ""}>Combo</option>
          <option value="Oferta" ${prod.categoria === "Oferta" ? "selected" : ""}>Oferta</option>
          <option value="Sin Stock" ${prod.categoria === "Sin Stock" ? "selected" : ""}>Sin Stock</option>          
        </select>
      </td>
      <td><!-- Input para la cantidad -->
      <input type="number" 
         value="${prod.cantidad || ''}" 
         onchange="editar(${inicio + index}, 'cantidad', this.value)" 
         style="width: 40px; text-align: center;" 
         min="0" step="0.01">

        <!-- Select para la unidad -->
        <select onchange="editar(${inicio + index}, 'unidad', this.value)" style="width: 70px;">
          <option value="Unidad" ${prod.unidad === "Unidad" ? "selected" : ""}>Unidad</option>
          <option value="Unidades" ${prod.unidad === "unidades" ? "selected" : ""}>Unidades</option>

        </select>
      </td>

      <td>
        <input type="text" value="${prod.imagen}" onchange="editar(${inicio + index}, 'imagen', this.value)" style="width: 90%; margin-top: 5px; text-align: center;">
        <div style="text-align: center; margin-top: 5px;">  
          ${prod.imagen ? `<img src="${prod.imagen}" style="max-width: 80px; display: inline-block;"> ‚úÖ` : '‚ùå Sin imagen'}
        </div>
      </td>
      <td><button onclick="eliminarProducto('${prod.id}', ${inicio + index})">üóëÔ∏è Eliminar</button></td>
    `;
        tbody.appendChild(fila);
      });
      // Ordenar productos por el campo 'orden'
      productos.sort((a, b) => (a.orden ?? 0) - (b.orden ?? 0));

      productosOriginales = JSON.parse(JSON.stringify(productos)); // Copia profunda

      sessionStorage.setItem("productosAdmin", JSON.stringify(productos));


      renderPaginacion(lista);
    }

    // üìÑ RENDERIZAR PAGINACI√ìN

    function renderPaginacion(lista) {
      const totalPaginas = Math.ceil(lista.length / productosPorPagina);
      const contenedor = document.getElementById("paginacion");
      contenedor.innerHTML = "";

      for (let i = 1; i <= totalPaginas; i++) {
        const btn = document.createElement("button");
        btn.textContent = i;
        btn.style.margin = "5px";
        btn.style.backgroundColor = i === paginaActual ? "#4CAF50" : "#e0e0e0";
        btn.style.color = i === paginaActual ? "white" : "black";
        btn.onclick = () => {
          paginaActual = i;
          renderTabla();
        };
        contenedor.appendChild(btn);
      }
    }

    // üóëÔ∏è ELIMINAR PRODUCTO

    window.eliminarProducto = async function (id) {
      if (confirm("¬øEst√°s seguro de eliminar este producto?")) {
        await deleteDoc(doc(productosRef, id));
        await mostrarProductos();
      }
    };

    //‚ûï GUARDAR PRODUCTO

    window.guardarProductos = async function () {
  sessionStorage.removeItem("productosAdmin");

  try {
    const operaciones = [];

    for (let i = 0; i < productos.length; i++) {
      const producto = productos[i];

      // üîπ Crear tipoVenta solo por compatibilidad
      let tipoVentaGenerado = "";
      if (producto.cantidad && producto.unidad) {
        tipoVentaGenerado = `${producto.cantidad} ${producto.unidad}`;
      }

      const data = {
        nombre: producto.nombre,
        precio: producto.precio,
        precioAnterior: producto.precioAnterior ?? null,
        descuento: producto.descuento ?? null,
        imagen: producto.imagen,
        categoria: producto.categoria,

        // üîπ Guardar nuevos campos
        cantidad: producto.cantidad ?? null,
        unidad: producto.unidad ?? "",

        // üîπ Mantener compatibilidad temporal
        tipoVenta: tipoVentaGenerado || null,

        precioMayorista: producto.precioMayorista ?? null,
        precioUnitario: producto.precioUnitario ?? null,
        unidadesPack: producto.unidadesPack ?? null,
        orden: i
      };

      if (!producto.id) {
        const docRef = await addDoc(productosRef, data);
        producto.id = docRef.id;
      } else {
        const original = productosOriginales.find(p => p.id === producto.id);
        if (
          !original ||
          original.nombre !== producto.nombre ||
          original.precio !== producto.precio ||
          original.precioAnterior !== producto.precioAnterior ||
          original.descuento !== producto.descuento ||
          original.imagen !== producto.imagen ||
          original.categoria !== producto.categoria ||
          original.cantidad !== producto.cantidad ||
          original.unidad !== producto.unidad ||
          original.precioUnitario !== producto.precioUnitario ||
          original.precioMayorista !== producto.precioMayorista ||
          original.unidadesPack !== producto.unidadesPack
        ) {
          const ref = doc(productosRef, producto.id);
          operaciones.push(updateDoc(ref, data));
        }
      }
    }
    await Promise.all(operaciones);

    productosOriginales = JSON.parse(JSON.stringify(productos));

    alert("‚úÖ Productos guardados correctamente.");
    localStorage.setItem("productosActualizados", Date.now());
    renderTabla();

  } catch (error) {
    console.error("‚ùå Error al guardar productos:", error);
    alert("‚ùå Error al guardar productos.");
  }
};


    document.getElementById("MATES-GUAY").textContent = tiendaId; //cambiar para nuevas tiendas
    let dragSrcEl = null;

    //  üéØ DRAG & DROP PARA REORDENAR PRODUCTOS

    function dragStart(e) {
      dragSrcEl = this;
      e.dataTransfer.effectAllowed = "move";
      e.dataTransfer.setData("text/html", this.innerHTML);
    }

    function dragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = "move";
    }
    
    async function drop(e) {
      e.preventDefault();
      if (dragSrcEl === this) return;

      const tbody = this.parentNode;
      const draggedIndexLocal = Array.from(tbody.children).indexOf(dragSrcEl);
      const targetIndexLocal = Array.from(tbody.children).indexOf(this);

      // üîß Calculamos el √≠ndice real en el array global
      const inicio = (paginaActual - 1) * productosPorPagina;
      const draggedIndexGlobal = inicio + draggedIndexLocal;
      const targetIndexGlobal = inicio + targetIndexLocal;

      const movedItem = productos.splice(draggedIndexGlobal, 1)[0];
      productos.splice(targetIndexGlobal, 0, movedItem);

      // Reasignar orden y actualizar Firestore
      const updates = productos.map((producto, i) => {
        producto.orden = i;
        if (producto.id) {
          const ref = doc(productosRef, producto.id);
          return updateDoc(ref, { orden: i });
        }
      });

      await Promise.all(updates);

      renderTabla();
    }

  </script>

  <script>
    // üëÅÔ∏è MOSTRAR / OCULTAR CONTRASE√ëA
    function togglePassword() {
      const input = document.getElementById("password");
      input.type = input.type === "password" ? "text" : "password";
    }
  </script>

</body>

</html>